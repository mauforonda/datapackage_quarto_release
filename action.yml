name: Datapackage → Quarto PDF → GitHub Release
description: Generate a Quarto PDF from datapackage.json and publish it as a GitHub Release asset bundle.

inputs:
  tag:
    description: Release tag (e.g., v1.0.0)
    required: true
  release_name:
    description: Release name (defaults to tag)
    required: false
    default: ""
  release_body:
    description: Release notes/body
    required: false
    default: ""

  datapackage_path:
    description: Path to datapackage.json
    required: false
    default: datapackage.json
  qmd_output:
    description: Output .qmd path
    required: false
    default: datapackage.qmd
  pdf_output:
    description: Output .pdf path
    required: false
    default: datapackage.pdf
  data_path:
    description: Path to data file to include (e.g., datos.csv)
    required: false
    default: data.csv

runs:
  using: composite
  steps:
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Generate QMD
      shell: bash
      run: |
        python "${{ github.action_path }}/datapackage2md.py" "${{ inputs.datapackage_path }}" "${{ inputs.qmd_output }}"

    - name: Setup Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        tinytex: true

    - name: Render PDF
      shell: bash
      run: |
        set +e
        quarto render "${{ inputs.qmd_output }}" --to pdf
        rc=$?
        set -e

        produced="${{ inputs.qmd_output }}"
        produced="${produced%.qmd}.pdf"

        if [ -f "$produced" ]; then
          mv "$produced" "${{ inputs.pdf_output }}"
          echo "PDF created at ${{ inputs.pdf_output }} (quarto exit code: $rc)"
          exit 0
        fi

        exit $rc

    - name: Bundle artifacts
      shell: bash
      run: |
        rm -rf dist
        mkdir -p dist
        cp "${{ inputs.pdf_output }}" dist/
        cp "${{ inputs.data_path }}" dist/
        (cd dist && zip -r ../datapackage-release.zip .)

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.tag }}
        name: ${{ inputs.release_name != '' && inputs.release_name || inputs.tag }}
        body: ${{ inputs.release_body }}
        files: |
          datapackage-release.zip
      env:
        GITHUB_TOKEN: ${{ github.token }}
